<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Math Solver (Photomath Simpel)</title>
    <!-- Memuat Tailwind CSS untuk styling modern dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Memuat Tesseract.js untuk OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- Memuat MathJax untuk menampilkan format matematika (LaTeX) dengan indah -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Latar belakang abu-abu muda */
        }
        /* Styling untuk area solusi MathJax */
        #solutionArea {
            min-height: 150px;
            background-color: #f8fafc; /* Latar belakang solusi sangat terang */
            border-left: 4px solid #10b981; /* Garis hijau cerah */
            padding: 1.5rem;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto bg-white shadow-2xl shadow-indigo-100 rounded-3xl p-6 md:p-12">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">âœ¨ Math Solver AI</h1>
            <p class="text-lg text-gray-500">Pecahkan soal matematika dengan gambar atau teks, langkah demi langkah.</p>
        </header>

        <!-- Area Status Global -->
        <div id="statusMessage" class="text-sm p-4 rounded-xl mb-6 shadow-md hidden transition duration-300">
            Aplikasi siap. Silakan unggah gambar atau ketik soal.
        </div>
        
        <!-- Pilihan Input (Grid Layout pada desktop) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">

            <!-- Card 1: Input Gambar (OCR) -->
            <div class="bg-indigo-50 p-6 rounded-2xl shadow-lg border border-indigo-100">
                <h2 class="flex items-center text-xl font-bold text-indigo-800 mb-4">
                    <!-- SVG Icon Kamera -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.865-1.297A2 2 0 0111.97 3h.063c.53 0 1.05.216 1.428.594l.865 1.297A2 2 0 0017.07 7H18a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    1. Selesaikan dari Gambar (OCR)
                </h2>
                <label class="block text-sm font-medium text-indigo-700 mb-3">Unggah Foto Soal</label>
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-600
                    file:py-2 file:px-4 file:rounded-xl file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-200 file:text-indigo-800
                    hover:file:bg-indigo-300 transition duration-150 cursor-pointer" />
                
                <button id="solveButton" onclick="processImage()"
                    class="w-full mt-4 py-3 px-4 bg-indigo-600 text-white font-semibold rounded-xl shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:opacity-50 transition duration-150"
                    disabled>
                    <span id="buttonText">Pilih Gambar Untuk Memulai</span>
                </button>
            </div>

            <!-- Card 2: Input Teks Manual (Kalkulator) -->
            <div class="bg-emerald-50 p-6 rounded-2xl shadow-lg border border-emerald-100">
                <h2 class="flex items-center text-xl font-bold text-emerald-800 mb-4">
                    <!-- SVG Icon Keyboard -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    2. Masukkan Manual (Kalkulator)
                </h2>
                <textarea id="textInput" rows="3" class="w-full p-3 border border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 placeholder-gray-500 text-gray-800 resize-none" placeholder="Contoh: x^2 + 5x = 10 atau Selesaikan integral dari x^2"></textarea>
                
                <button id="solveTextButton" onclick="processText()"
                    class="w-full mt-4 py-3 px-4 bg-emerald-600 text-white font-semibold rounded-xl shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-150">
                    Selesaikan Soal Teks
                </button>
            </div>

        </div>

        <!-- Area Hasil dan Solusi -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Hasil Pemecahan Soal</h2>
            
            <!-- Area Teks yang Digunakan -->
            <div class="bg-gray-100 p-4 rounded-xl mb-4 border-l-4 border-gray-400">
                <p class="text-sm font-semibold text-gray-700">Teks yang Diproses:</p>
                <code id="ocrResult" class="block mt-1 text-gray-900 text-sm whitespace-pre-wrap font-mono"></code>
            </div>

            <!-- Area Solusi Utama (MathJax Rendering) -->
            <div>
                <p class="text-lg font-bold text-gray-800 mb-3">Solusi Langkah demi Langkah:</p>
                <div id="solutionArea" class="rounded-xl shadow-xl">
                    <p class="text-gray-500 italic">Solusi akan muncul di sini setelah diproses AI.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-10 pt-6 border-t border-gray-200 text-center">
            <p class="text-sm text-gray-500">Dibuat oleh <span class="font-semibold text-gray-700">Harry S.A Nadapdap</span></p>
            <p class="text-xs text-gray-400 mt-1">Menggunakan Gemini AI untuk memecahkan soal matematika.</p>
        </footer>

    </div>

    <!-- Firebase dan Logic Script -->
    <script type="module">
        // Import Firebase (Wajib ada untuk kepatuhan lingkungan Canvas)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global dari lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        
        // Konstanta API Gemini
        const API_KEY = ""; // Kunci API akan diisi oleh lingkungan Canvas
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-Aflash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // Elemen UI
        const imageInput = document.getElementById('imageInput');
        const solveButton = document.getElementById('solveButton');
        const buttonText = document.getElementById('buttonText');
        const textInput = document.getElementById('textInput'); 
        const solveTextButton = document.getElementById('solveTextButton');
        const statusMessage = document.getElementById('statusMessage');
        const ocrResult = document.getElementById('ocrResult');
        const solutionArea = document.getElementById('solutionArea');

        // Fungsi utilitas untuk Retry dengan Exponential Backoff
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`429 Too Many Requests. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Lanjutkan ke loop berikutnya untuk retry
                }
            }
        }

        // 1. Inisialisasi Firebase dan Autentikasi (Wajib)
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase dan Autentikasi berhasil.");
            } catch (error) {
                console.error("Gagal menginisialisasi Firebase:", error);
            }
        }

        // 2. Event Listener untuk Input Gambar
        imageInput.addEventListener('change', () => {
            if (imageInput.files.length > 0) {
                solveButton.disabled = false;
                buttonText.textContent = 'Mulai Pemecahan Soal';
            } else {
                solveButton.disabled = true;
                buttonText.textContent = 'Pilih Gambar Untuk Memulai';
            }
        });
        
        // Fungsi pembantu untuk mengaktifkan/menonaktifkan tombol
        function setSolvingState(isSolving) {
            solveButton.disabled = isSolving || (imageInput.files.length === 0);
            solveTextButton.disabled = isSolving;
            textInput.disabled = isSolving;
            imageInput.disabled = isSolving;
        }

        // 3. Fungsi Utama: Proses Gambar -> OCR -> Solver AI
        window.processImage = async function() {
            const file = imageInput.files[0];
            if (!file) {
                alertUser("Peringatan", "Mohon pilih file gambar terlebih dahulu.");
                return;
            }

            // Reset UI & Set State
            setSolvingState(true);
            ocrResult.textContent = 'Memproses Gambar...';
            solutionArea.innerHTML = '<p class="text-gray-500 italic">Memproses...</p>';
            
            try {
                // Tesseract.js (OCR) - Langkah 1: Ekstraksi Teks
                alertUser("Status OCR", "Langkah 1/3: Memulai OCR. Ini mungkin membutuhkan waktu...", "yellow");
                
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'eng', // Menggunakan bahasa Inggris untuk hasil terbaik
                    { 
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                statusMessage.textContent = `Langkah 1/3: ${m.status}: ${(m.progress * 100).toFixed(0)}%`;
                            }
                        }
                    }
                );
                
                const cleanedText = text.trim();
                ocrResult.textContent = cleanedText || "Tidak ada teks yang terdeteksi.";
                alertUser("Status OCR", `Langkah 2/3: OCR Selesai. Teks yang dikenali: "${cleanedText}"`, "yellow");

                if (!cleanedText) {
                    alertUser("Gagal", "Teks matematika tidak terdeteksi. Coba gambar yang lebih jelas.", "red");
                    return;
                }

                // Gemini API (Solver) - Langkah 3: Memecahkan Soal
                await solveMath(cleanedText, "Langkah 3/3");

            } catch (error) {
                console.error("Error selama proses:", error);
                alertUser("Error", "Terjadi kesalahan fatal. Cek konsol untuk detail.", "red");
            } finally {
                setSolvingState(false);
                buttonText.textContent = 'Mulai Pemecahan Soal Lagi';
            }
        }
        
        // 3b. Fungsi Utama: Proses Teks Manual -> Solver AI (Fitur Kalkulator Baru)
        window.processText = async function() {
            const mathText = textInput.value.trim();
            if (!mathText) {
                alertUser("Peringatan", "Mohon masukkan soal matematika di kolom teks.", "red");
                return;
            }

            // Reset UI & Set State
            setSolvingState(true);
            ocrResult.textContent = mathText;
            solutionArea.innerHTML = '<p class="text-gray-500 italic">Memproses...</p>';
            
            try {
                alertUser("Status Input Teks", `Langkah 1/1: Mengirim soal manual: "${mathText}"`, "yellow");
                
                // Gemini API (Solver) - Langkah 1: Memecahkan Soal
                await solveMath(mathText, "Langkah 1/1");
            } catch (error) {
                console.error("Error selama proses teks:", error);
                alertUser("Error", "Terjadi kesalahan fatal saat memproses teks. Cek konsol.", "red");
            } finally {
                setSolvingState(false);
            }
        }


        // 4. Fungsi Pemecahan Soal (Memanggil Gemini API)
        async function solveMath(mathText, stepStatus) {
            alertUser("Status AI", `${stepStatus}: Mengirim soal ke AI untuk dipecahkan. Mohon tunggu...`, "yellow");
            solutionArea.innerHTML = '<div class="flex items-center space-x-2 text-blue-500 font-semibold"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>AI sedang memecahkan soal...</span></div>';

            const systemPrompt = `Anda adalah pemecah soal matematika profesional yang ramah dan membantu. Tugas Anda adalah mengambil persamaan atau soal matematika yang diberikan, menyelesaikannya langkah demi langkah, dan memberikan jawaban akhirnya. 
            Format SEMUA persamaan matematika dan langkah-langkah menggunakan sintaks LaTeX. 
            Gunakan '\n\n' untuk memisahkan setiap langkah dan paragraf. Jangan menggunakan heading markdown.
            Contoh output:
            Langkah 1: Tulis ulang persamaan
            $$x^2 - 4 = 0$$
            Langkah 2: Faktorkan persamaan
            $$(x-2)(x+2) = 0$$
            Langkah 3: Terapkan properti nol
            $$x-2=0 \quad \text{atau} \quad x+2=0$$
            Langkah 4: Selesaikan untuk x
            $$x=2 \quad \text{atau} \quad x=-2$$
            Jawaban Akhir: Solusinya adalah $x=2$ dan $x=-2$.`;

            const payload = {
                contents: [{ parts: [{ text: mathText }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Tampilkan hasil teks LaTeX dan panggil MathJax untuk merender
                    solutionArea.innerHTML = text;
                    if (window.MathJax) {
                         // Tunggu sampai MathJax siap, lalu render ulang konten
                         await MathJax.typesetPromise([solutionArea]);
                    }
                    alertUser("Sukses", "Solusi ditemukan dan ditampilkan!", "green");
                } else {
                    solutionArea.innerHTML = '<p class="text-red-500 font-semibold">Gagal mendapatkan solusi dari AI. Coba lagi atau periksa teks input.</p>';
                    alertUser("Gagal", "Gagal mendapatkan solusi dari AI. Coba lagi atau periksa teks input.", "red");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                solutionArea.innerHTML = '<p class="text-red-500 font-semibold">Koneksi ke AI gagal. Periksa koneksi internet atau konsol.</p>';
                alertUser("Error", "Koneksi ke AI gagal.", "red");
            }
        }
        
        // 5. Fungsi Pesan Pengguna yang Diperbarui (Menggunakan warna yang lebih dinamis)
        function alertUser(title, message, color) {
            statusMessage.textContent = `${title}: ${message}`;
            statusMessage.className = 'text-sm p-4 rounded-xl mb-6 shadow-md transition duration-300'; // Reset classes
            
            if (color === "red") {
                statusMessage.classList.add('text-red-800', 'bg-red-200', 'border', 'border-red-300');
            } else if (color === "green") {
                statusMessage.classList.add('text-green-800', 'bg-green-200', 'border', 'border-green-300');
            } else { // Default to yellow/blue for processing
                statusMessage.classList.add('text-yellow-800', 'bg-yellow-200', 'border', 'border-yellow-300');
            }
            statusMessage.classList.remove('hidden');
            console.log(`${title}: ${message}`);
        }

        // Mulai aplikasi
        initFirebase();
        alertUser("Siap", "Aplikasi siap digunakan. Pilih mode input Kamu.", "green");

    </script>
</body>
</html>